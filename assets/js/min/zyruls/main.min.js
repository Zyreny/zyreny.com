document.addEventListener("DOMContentLoaded",(()=>{initPage("縮網址服務 - Zyreny","Zyreny 提供的免費網址縮短服務，支援自訂連結、密碼保護、統計分析","#2885e2"),loadFonts(["Fira Code","Huninn","Noto Sans TC"]),loadNav([{id:"home",name:"首頁",href:"/"},{id:"projects",name:"作品",href:"/#Projects"},{id:"contact",name:"聯絡",href:"/#Contact"}])}));const API_BASE_URL="https://api.zyreny.com/url_shortener";async function apiRequest(t,e={}){const s={...e,headers:{"Content-Type":"application/json",...e.headers}};return await fetch(`${API_BASE_URL}${t}`,s)}const tabButtons=document.querySelectorAll(".tab-button"),tabContents=document.querySelectorAll(".tab-content"),createForm=document.getElementById("createForm"),createBtn=document.getElementById("createBtn"),resultCard=document.getElementById("resultCard"),resultUrl=document.getElementById("resultUrl"),copyBtn=document.getElementById("copyBtn"),copyStatus=document.getElementById("copyStatus"),resultMeta=document.getElementById("resultMeta"),urlList=document.getElementById("urlList"),emptyState=document.getElementById("emptyState"),refreshBtn=document.getElementById("refreshBtn"),passwordToggle=document.getElementById("passwordToggle"),passwordInput=document.getElementById("password"),originalUrlInput=document.getElementById("originalUrl"),metadataToggle=document.getElementById("metadataToggle"),metadataSection=document.getElementById("metadataSection"),metaTitleInput=document.getElementById("metaTitle"),metaDescriptionInput=document.getElementById("metaDescription"),metaImageInput=document.getElementById("metaImage"),alertSuccess=document.getElementById("alertSuccess"),alertError=document.getElementById("alertError"),alertSuccessText=document.getElementById("alertSuccessText"),alertErrorText=document.getElementById("alertErrorText"),alertSuccess2=document.getElementById("alertSuccess2"),alertError2=document.getElementById("alertError2"),alertSuccessText2=document.getElementById("alertSuccessText2"),alertErrorText2=document.getElementById("alertErrorText2");let urls=[];function initTabs(){tabButtons.forEach((t=>{t.addEventListener("click",(()=>{switchTab(t.dataset.tab)}))}))}function switchTab(t){tabButtons.forEach((t=>t.classList.remove("active"))),document.querySelector(`[data-tab="${t}"]`).classList.add("active"),tabContents.forEach((t=>t.classList.remove("active"))),document.getElementById(t+"Tab").classList.add("active"),"manage"===t&&loadUrlList(),hideAlerts()}function initPasswordToggle(){passwordToggle.addEventListener("click",(()=>{const t="password"===passwordInput.type;passwordInput.type=t?"text":"password";const e=passwordToggle.querySelector("svg");e.innerHTML=t?'<path d="m644-428-58-58q9-47-27-88t-93-32l-58-58q17-8 34.5-12t37.5-4q75 0 127.5 52.5T660-500q0 20-4 37.5T644-428Zm128 126-58-56q38-29 67.5-63.5T832-500q-50-101-143.5-160.5T480-720q-29 0-57 4t-55 12l-62-62q41-17 84-25.5t90-8.5q151 0 269 83.5T920-500q-23 59-60.5 109.5T772-302Zm20 246L624-222q-35 11-70.5 16.5T480-200q-151 0-269-83.5T40-500q21-53 53-98.5t73-81.5L56-792l56-56 736 736-56 56ZM222-624q-29 26-53 57t-41 67q50 101 143.5 160.5T480-280q20 0 39-2.5t39-5.5l-36-38q-11 3-21 4.5t-21 1.5q-75 0-127.5-52.5T300-500q0-11 1.5-21t4.5-21l-84-82Zm319 93Zm-151 75Z"/>':'<path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/>'}))}function initMetadataToggle(){metadataToggle.addEventListener("click",(()=>{metadataSection.classList.contains("expanded")?(metadataSection.classList.remove("expanded"),metadataToggle.classList.remove("expanded")):(metadataSection.classList.add("expanded"),metadataToggle.classList.add("expanded"))}))}function initUrlValidation(){let t,e=!1;function s(t){if(t&&e)try{const e=new URL(t);"http:"===e.protocol||"https:"===e.protocol?(originalUrlInput.classList.remove("invalid"),originalUrlInput.classList.add("valid")):(originalUrlInput.classList.remove("valid"),originalUrlInput.classList.add("invalid"))}catch(t){originalUrlInput.classList.remove("valid"),originalUrlInput.classList.add("invalid")}else originalUrlInput.classList.remove("invalid","valid")}const n=(a=t=>s(t),o=500,function(...e){clearTimeout(t),t=setTimeout((()=>{clearTimeout(t),a(...e)}),o)});var a,o;originalUrlInput.addEventListener("input",(t=>{e=!0,originalUrlInput.classList.remove("invalid","valid"),n(t.target.value.trim())})),originalUrlInput.addEventListener("blur",(n=>{e&&(clearTimeout(t),s(n.target.value.trim()))})),originalUrlInput.addEventListener("focus",(()=>{e=!0,originalUrlInput.classList.remove("invalid","valid")}))}function initCustomCodeValidation(){let t,e=!1;const s=document.getElementById("customCode");function n(t){if(!t)return void s.classList.remove("invalid","valid");if(!e)return;/^[a-zA-Z0-9-_]{3,20}$/.test(t)?(s.classList.remove("invalid"),s.classList.add("valid")):(s.classList.remove("valid"),s.classList.add("invalid"))}const a=(o=t=>n(t),r=500,function(...e){clearTimeout(t),t=setTimeout((()=>{clearTimeout(t),o(...e)}),r)});var o,r;s.addEventListener("input",(t=>{e=!0,s.classList.remove("invalid","valid"),a(t.target.value.trim())})),s.addEventListener("blur",(s=>{e&&(clearTimeout(t),n(s.target.value.trim()))})),s.addEventListener("focus",(()=>{e=!0,s.classList.remove("invalid","valid")}))}function initFormSubmit(){createForm.addEventListener("submit",(async t=>{t.preventDefault(),await createShortUrl()}))}async function createShortUrl(){const t=document.getElementById("originalUrl").value,e=document.getElementById("customCode").value,s=document.getElementById("password").value,n=document.getElementById("expiration").value,a=metaTitleInput.value,o=metaDescriptionInput.value,r=metaImageInput.value;if(!t)return void showError("請輸入網址");setLoading(!0),hideAlerts();const i={};let l;if(a&&(i.title=a),o&&(i.description=o),r&&(i.image=r),n){const t=new Date(n),e=480,s=t.getTime()-6e4*t.getTimezoneOffset();l=new Date(s+6e4*e).toISOString().replace("Z","+08:00")}try{const n={url:t,custom:e||void 0,password:s||void 0,expiration:l};Object.keys(i).length>0&&(n.metadata=i);const a=await apiRequest("/shorten",{method:"POST",body:JSON.stringify(n)}),o=await a.json();a.ok?(showResult(o),createForm.reset(),metadataSection.classList.remove("expanded"),metadataToggle.classList.remove("expanded"),showSuccess("短網址建立成功！")):showError(o.message||"建立失敗")}catch(t){showError("網路錯誤，請稍後再試")}finally{setLoading(!1)}}function showResult(t){if(!t)return;resultUrl.value=t.shortUrl||"";let e=`<span>建立時間：${formatDate(t.created)}</span>`;t.hasPassword&&(e+='<span><svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#2885e2"><path d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Zm0-80h480v-400H240v400Zm240-120q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM360-640h240v-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80ZM240-160v-400 400Z"/></svg> 密碼保護</span>'),t.expiration&&(e+=`<span><svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#d97706"><path d="m612-292 56-56-148-148v-184h-80v216l172 172ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-400Zm0 320q133 0 226.5-93.5T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160Z"/></svg> 過期時間：${formatDate(t.expiration)}</span>`),t.metadata&&(e+='<span><svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#10b981"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-480H200v480Zm80-40h400L545-420 440-280l-65-87-95 127Zm-80 40v-560 560Z"/></svg> 社群媒體預覽</span>'),resultMeta.innerHTML=e,resultCard.classList.add("show","fade-in")}function initCopyButton(){copyBtn.addEventListener("click",(()=>{copyToClipboard(resultUrl.value)}))}async function copyToClipboard(t){try{await navigator.clipboard.writeText(t),showCopyStatus("已複製到剪貼簿！","success")}catch(e){try{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),showCopyStatus("已複製到剪貼簿！","success")}catch(t){showCopyStatus("複製失敗，請手動複製","error")}}}function showCopyStatus(t,e="success"){copyStatus.textContent=t,copyStatus.className=`copy-status show ${e}`,setTimeout((()=>{copyStatus.classList.remove("show"),setTimeout((()=>{copyStatus.classList.contains("show")||(copyStatus.textContent="")}),300)}),3e3)}async function copyUrlToClipboard(t,e){try{await navigator.clipboard.writeText(t),showUrlCopyStatus(e,"已複製！","success")}catch(s){try{const s=document.createElement("textarea");s.value=t,document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),showUrlCopyStatus(e,"已複製！","success")}catch(t){showUrlCopyStatus(e,"複製失敗","error")}}}function showUrlCopyStatus(t,e,s="success"){const n=document.getElementById(`copyStatus-${t}`);n&&(n.textContent=e,n.className=`copy-status show ${s}`,setTimeout((()=>{n.classList.remove("show"),setTimeout((()=>{n.classList.contains("show")||(n.textContent="")}),300)}),2e3))}async function loadUrlList(){try{const t=await apiRequest("/list"),e=await t.json();t.ok?(urls=e.urls||[],renderUrlList()):(urls||(urls=[]),showError(e.error||"載入列表失敗"))}catch(t){urls||(urls=[]),showError(t.error||"網路錯誤")}}function renderUrlList(){if(urls&&Array.isArray(urls)||(urls=[]),0===urls.length)return urlList.style.display="none",void(emptyState.style.display="block");urlList.style.display="block",emptyState.style.display="none",urlList.innerHTML=urls.map((t=>{if(!t||"object"!=typeof t)return"";const e=t.code||"",s=t.url||"",n=t.created||"",a=t.hasPassword||!1,o=t.expiration||null,r=t.metadata||!1;return`\n        <div class="url-item fade-in">\n            <div class="url-item-header">\n                <div class="url-item-content">\n                    <div class="short-url">\n                        zye.me/${e}\n                        <button type="button" class="btn btn-small btn-secondary" onclick="copyUrlToClipboard('https://zye.me/${e}', '${e}')">\n                            <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#174879">\n                                <path d="M360-240q-33 0-56.5-23.5T280-320v-480q0-33 23.5-56.5T360-880h360q33 0 56.5 23.5T800-800v480q0 33-23.5 56.5T720-240H360Zm0-80h360v-480H360v480ZM200-80q-33 0-56.5-23.5T120-160v-560h80v560h440v80H200Zm160-240v-480 480Z"/>\n                            </svg>\n                        </button>\n                    </div>\n                    <div id="copyStatus-${e}" class="copy-status"></div>\n                    <div class="original-url" title="${s}">${truncateUrl(s,60)}</div>\n                    <div class="url-meta">\n                        <span>建立時間：${formatDate(n)}</span>\n                        ${a?'<span><svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#2885e2"><path d="M240-80q-33 0-56.5-23.5T160-160v-400q0-33 23.5-56.5T240-640h40v-80q0-83 58.5-141.5T480-920q83 0 141.5 58.5T680-720v80h40q33 0 56.5 23.5T800-560v400q0 33-23.5 56.5T720-80H240Zm0-80h480v-400H240v400Zm240-120q33 0 56.5-23.5T560-360q0-33-23.5-56.5T480-440q-33 0-56.5 23.5T400-360q0 33 23.5 56.5T480-280ZM360-640h240v-80q0-50-35-85t-85-35q-50 0-85 35t-35 85v80ZM240-160v-400 400Z"/></svg> 密碼保護</span>':""}\n                        ${o?`<span><svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#d97706"><path d="m612-292 56-56-148-148v-184h-80v216l172 172ZM480-80q-83 0-156-31.5T197-197q-54-54-85.5-127T80-480q0-83 31.5-156T197-763q54-54 127-85.5T480-880q83 0 156 31.5T763-763q54 54 85.5 127T880-480q0 83-31.5 156T763-197q-54 54-127 85.5T480-80Zm0-400Zm0 320q133 0 226.5-93.5T800-480q0-133-93.5-226.5T480-800q-133 0-226.5 93.5T160-480q0 133 93.5 226.5T480-160Z"/></svg> 過期：${formatDate(o)}</span>`:""}\n                        ${r?'<span><svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#10b981"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Z"/></svg> 社群媒體預覽</span>':""}\n                    </div>\n                </div>\n                <div class="url-item-actions">\n                    <button type="button" class="btn btn-small btn-danger" onclick="deleteUrl('${e}')" title="刪除">\n                        <svg class="icon-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" fill="#ffffff">\n                            <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>\n                        </svg>\n                    </button>\n                </div>\n            </div>\n        </div>\n        `})).filter(Boolean).join("")}async function deleteUrl(t){if(confirm("確定要刪除這個短網址嗎？此操作無法復原。"))try{const e=await apiRequest(`/delete/${t}`,{method:"DELETE"});if(e.ok)showSuccess("短網址已刪除"),loadUrlList();else{showError((await e.json()).error||"刪除失敗")}}catch(t){showError("網路錯誤")}}function initRefreshButton(){refreshBtn.addEventListener("click",(async function(){const t=refreshBtn.innerHTML;refreshBtn.disabled=!0,refreshBtn.innerHTML='<span class="loading"></span> 載入中...';try{await loadUrlList()}finally{refreshBtn.disabled=!1,refreshBtn.innerHTML=t}}))}function setLoading(t){t?(createBtn.disabled=!0,createBtn.innerHTML='<span class="loading"></span> 建立中...'):(createBtn.disabled=!1,createBtn.innerHTML="建立短網址")}function showSuccess(t){const e=document.getElementById("createTab").classList.contains("active"),s=e?alertSuccess:alertSuccess2,n=e?alertSuccessText:alertSuccessText2;hideAlerts(),n.textContent=t,requestAnimationFrame((()=>{s.classList.add("show")})),setTimeout((()=>{s.classList.remove("show"),setTimeout((()=>{s.classList.contains("show")||(n.textContent="")}),400)}),5e3)}function showError(t){const e=document.getElementById("createTab").classList.contains("active"),s=e?alertError:alertError2,n=e?alertErrorText:alertErrorText2;hideAlerts(),n.textContent=t,requestAnimationFrame((()=>{s.classList.add("show")})),setTimeout((()=>{s.classList.remove("show"),setTimeout((()=>{s.classList.contains("show")||(n.textContent="")}),400)}),5e3)}function hideAlerts(){alertSuccess.classList.remove("show"),alertError.classList.remove("show"),alertSuccess2.classList.remove("show"),alertError2.classList.remove("show"),setTimeout((()=>{alertSuccess.classList.contains("show")||(alertSuccessText.textContent=""),alertError.classList.contains("show")||(alertErrorText.textContent=""),alertSuccess2.classList.contains("show")||(alertSuccessText2.textContent=""),alertError2.classList.contains("show")||(alertErrorText2.textContent="")}),400)}function formatDate(t){if(!t)return"未設定";const e=new Date(t);if(isNaN(e.getTime()))return"無效日期";let s=e;return t.includes("+08:00")||t.includes("+0800")||(s=new Date(e.getTime()+288e5)),s.toLocaleString("zh-TW",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",timeZone:"Asia/Taipei"})+" (台北時間)"}function truncateUrl(t,e){return t&&"string"==typeof t?t.length<=e?t:t.substring(0,e-3)+"...":""}window.addEventListener("error",(function(t){t.error&&t.error.message&&t.error.message.includes("Cannot read properties of undefined")})),document.addEventListener("DOMContentLoaded",(function(){initTabs(),initPasswordToggle(),initMetadataToggle(),initFormSubmit(),initCopyButton(),initRefreshButton(),initUrlValidation(),initCustomCodeValidation(),loadUrlList()})),window.copyToClipboard=copyToClipboard,window.copyUrlToClipboard=copyUrlToClipboard,window.deleteUrl=deleteUrl;